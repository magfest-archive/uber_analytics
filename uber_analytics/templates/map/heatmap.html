{% extends "base.html" %}
{% block title %}Attendance HeatMap{% endblock %}
{% block content %}
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBc0XLtT-jCG3-v0JFLo9vSr2xYljpRRh4"></script>
    <script src="../static/analytics/heatmap.min.js"></script>
    <script src="../static/analytics/g-heatmap.js"></script>
    <style>
        /* Always set the map height explicitly to define the size of the div
        * element that contains the map. */
        #map {
            height: 100%;
            position: static;
        }

        /* Optional: Makes the sample page fill the window. */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>

    <div class="row">
        <div class="panel col-md-3">
            <form id="refresh">
                <input type="submit" value="Refresh (May Take A While)">
            </form>
            <br>
            <br>
            <form id="radial" action="radial_zip_data">
                <input type="number" id="radius" name="radius" min="1" placeholder="Miles From Event..." required><br>
                <input type="submit" value="Get CSV">
            </form>
            <br>
            <br>
            <p>Current Zip: {{ center.Zipcode }}</p>
            <form id="set_center">
                <input type="text" id="zip" placeholder="New Zip Code..." required><input type="submit" value="Set Center">
            </form>
        </div>
        <div style="height:48em" class="panel col-md-9">
            <div id="map"></div>
        </div>
    </div>

    <script>
    $("#refresh").submit(function(e){
        e.preventDefault();
        $.ajax({
            url: "refresh",
            data: {
                csrf_token: csrf_token
            },
            type: "POST",
            success: function(e){
                window.location.reload();
            }

        });
    });
    $("#radial").submit(function(e){
        e.preventDefault();
        var distance = $("#radius");
        this.submit();
        distance.val("");
    });

    $("#set_center").submit(function(e){
        e.preventDefault();
        var zip = $("#zip");
        $.ajax({
            url: "set_center",
            data: {
                zip: zip.val(),
                csrf_token: csrf_token
            },
            type: "POST",
            success: function(e){
                alert(e);
                window.location.reload();
            }
        });
        zip.val("");
    });

    var refresh = function(){
        return false;
    };

    var set_center = function(center_form){
        console.log(center_form);
        return false;
    };

    var center = {
        "lat": {{ center.Latitude }},
        "lng": {{ center.Longitude }}
    };
    var map;
    function initMap() {

        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 10,
            center: center
        });
        var heatmap = new HeatmapOverlay(map,{
            // radius should be small ONLY if scaleRadius is true (or small radius is intended)
            "radius": 2,
            "maxOpacity": 1,
            // scales the radius based on map zoom
            "scaleRadius": true,
            // if set to false the heatmap uses the global maximum for colorization
            // if activated: uses the data maximum within the current map boundaries
            //   (there will always be a red spot with useLocalExtremas true)
            "useLocalExtrema": true,
            // which field name in your data represents the latitude - default "lat"
            latField: 'lat',
            // which field name in your data represents the longitude - default "lng"
            lngField: 'lng',
            // which field name in your data represents the data value - default "value"
            valueField: 'count'
        });

        {% for key, value in zips.items() %}
            heatmap.addData({
                lat: {{ value.Latitude }},
                lng: {{ value.Longitude }},
                count: {{ zip_counts|get_count(key) }}
            });
        {% endfor %}
    }
    initMap();
    </script>



{% endblock %}
